# Ralph Progress Log - Content Engine Phase 3

**Project:** ContentEngine - Semantic Blueprints
**Started:** 2026-01-17
**Goal:** Implement blueprint system for content framework encoding, validation, and generation

## Codebase Patterns

**Package Manager:**
- Always use `uv run` prefix for Python commands
- Install dependencies: `uv add package-name`
- Sync environment: `uv sync`

**File Paths:**
- Use `pathlib.Path` and `os.path.expanduser()`
- Blueprint files: `blueprints/frameworks/`, `blueprints/workflows/`, `blueprints/constraints/`
- Templates: `blueprints/templates/`

**Database:**
- SQLAlchemy ORM with context managers
- Models in `lib/database.py`
- Use `with get_session() as session:` pattern
- Always call `session.commit()` explicitly

**YAML Blueprints:**
- Use PyYAML for parsing
- Cache loaded blueprints in memory for performance
- Validate YAML structure on load

**Testing:**
- pytest fixtures for test data in `conftest.py`
- Mock external dependencies (LLM, file system)
- Test both success and failure paths

**Key Files:**
- `lib/database.py` - Database models
- `lib/context_synthesizer.py` - Phase 2 context capture (already implemented)
- `cli.py` - CLI commands
- `tests/conftest.py` - Shared test fixtures

## Architecture Overview

**Phase 3 adds:**
1. Blueprint system (YAML-based content frameworks)
2. Validation engine (brand voice, platform rules)
3. Content generator (blueprint-driven LLM prompts)
4. Workflow executor (batching, repurposing)

**Integration with Phase 2:**
- Context from `synthesize_daily_context()` â†’ Blueprint prompts â†’ LLM generation

---

# Implementation Log

(Ralph will append completed stories here)

## [2026-01-17] - CE-BP-001 - Create blueprint directory structure

**Implemented:**
- Created blueprints/ directory with subdirectories: frameworks/linkedin/, workflows/, constraints/, templates/
- Added comprehensive README.md explaining blueprint system architecture
- Created tests to verify directory structure

**Files changed:**
- blueprints/README.md (new)
- tests/test_blueprint_structure.py (new)

**Learnings:**
- Blueprint directory provides foundation for all YAML-based content frameworks
- README serves as documentation for blueprint types: frameworks, workflows, constraints, templates
- Test ensures directory structure exists for subsequent blueprint file creation

**Tests:**
- mypy: PASS
- ruff: PASS
- pytest: PASS (2 new tests added)

**Commit:** 68a2264

---

## [2026-01-17] - CE-BP-002 - Implement blueprint_loader.py

**Implemented:**
- Created lib/blueprint_loader.py with comprehensive blueprint loading system
- load_framework(name, platform) - Load framework blueprints with platform support
- load_workflow(name) - Load workflow blueprints
- load_constraints(name) - Load constraint blueprints
- clear_cache() - Cache management (full and selective invalidation)
- list_blueprints() - Blueprint discovery across all categories
- In-memory caching with cache key pattern: "{type}:{platform}:{name}"

**Files changed:**
- lib/blueprint_loader.py (new)
- tests/test_blueprint_loader.py (new)
- pyproject.toml (added pyyaml, types-pyyaml)
- uv.lock (updated)

**Learnings:**
- PyYAML safe_load returns Any type - need cast() for mypy compliance
- Cache invalidation supports both full clear and selective key removal
- Monkeypatch in pytest allows mocking get_blueprints_dir() for testing
- YAML parsing errors need to be caught and re-raised with context
- Blueprint discovery walks directory structure to find all YAML files

**Tests:**
- 13 comprehensive tests covering:
  - Successful loading of all blueprint types
  - File not found error handling
  - Invalid YAML error handling
  - Cache behavior (hit/miss/invalidation)
  - Selective cache clearing
  - Blueprint listing (all and filtered)
- mypy: PASS
- ruff: PASS
- pytest: PASS (77 total tests, 13 new)

**Commit:** 7fbf034

---

## [2026-01-17] - CE-BP-003 - Implement template_renderer.py

**Implemented:**
- Created lib/template_renderer.py with Handlebars-style template rendering
- render_template(name, context) - Load and render template from blueprints/templates/
- render_template_string(template, context) - Render template string directly
- get_templates_dir() - Helper to get templates directory path
- Chose Chevron over pybars3 (simpler, well-maintained, Mustache-compatible)

**Files changed:**
- lib/template_renderer.py (new)
- tests/test_template_renderer.py (new)
- pyproject.toml (added chevron)
- uv.lock (updated)

**Learnings:**
- Chevron uses Mustache syntax, not full Handlebars (simpler)
- Loop syntax: {{#items}}{{.}}{{/items}} (not {{#each}})
- Conditional syntax: {{#condition}}...{{/condition}} (not {{#if}})
- Chevron escapes HTML entities by default (& becomes &amp;)
- Missing variables render as empty strings (graceful degradation)
- cast() needed for mypy since chevron.render returns Any
- type: ignore[import-untyped] needed for chevron import

**Codebase patterns discovered:**
- Mustache {{.}} refers to current item in loop iteration
- {{^condition}} is inverted section (renders if false/empty)
- {{#items}} iterates over lists, {{#object}} checks truthiness
- Nested objects accessed with dot notation: {{user.name}}

**Tests:**
- 12 comprehensive tests covering:
  - Simple and complex templates
  - Loops, conditionals, nested objects
  - Error handling (file not found, missing variables)
  - HTML escaping behavior
  - Unicode support
- mypy: PASS
- ruff: PASS
- pytest: PASS (89 total tests, 12 new)

**Commit:** 7b02b40

---

## [2026-01-17] - CE-BP-004 - Add Blueprint cache table to database

**Implemented:**
- Added Blueprint model to lib/database.py with all required fields
- id, name, category, platform (nullable), data (JSON), version, timestamps
- Created Alembic migration 4864d1c47cec
- Successfully ran migration to create blueprints table in SQLite

**Files changed:**
- lib/database.py (added Blueprint model, imported JSON from sqlalchemy)
- alembic/versions/4864d1c47cec_add_blueprint_table_for_blueprint_.py (new migration)
- tests/test_blueprint_model.py (new test file)

**Learnings:**
- SQLAlchemy JSON column type stores Python dicts/lists as JSON in SQLite
- Alembic --autogenerate correctly detects new model and generates migration
- setattr() avoids mypy assignment errors when updating Column attributes
- Platform field is nullable for workflows/constraints (only frameworks have platform)
- JSON data persists correctly including nested objects and arrays
- datetime.utcnow() generates deprecation warnings in SQLAlchemy (use datetime.now(UTC) in future)

**Codebase patterns discovered:**
- Use SessionLocal() for database sessions, commit explicitly
- db.refresh() after commit to reload model with updated timestamps
- JSON column allows complex nested data structures
- Alembic migrations maintain schema version history

**Tests:**
- 8 comprehensive tests for Blueprint CRUD:
  - Create, read, update, delete operations
  - Query by category
  - NULL platform handling
  - Complex nested JSON persistence
  - repr method
- pytest: PASS (97 total tests, 8 new)

**Note:** Pre-existing mypy errors in database.py (Session name conflict) 
not addressed as they're unrelated to this story.

**Commit:** f6d9597

---

## [2026-01-17] - CE-BP-005 - Add blueprints CLI group with list command

**Implemented:**
- Added blueprints CLI command group to cli.py
- Implemented `content-engine blueprints list` command
- Optional --category filter (frameworks/workflows/constraints)
- Organized output with category grouping and formatting

**Files changed:**
- cli.py (added blueprints group, list command)
- tests/test_blueprints_cli.py (new CLI tests)

**Learnings:**
- Click's @cli.group() creates command groups (like git has subcommands)
- CliRunner from click.testing allows testing CLI commands without actual execution
- Monkeypatch can mock blueprint_loader.get_blueprints_dir() for isolated testing
- sorted() on dict.items() ensures consistent category ordering in output
- Optional[] type hint needed for click.option with default=None

**CLI output format:**
```
ðŸ“‹ Available Blueprints

  FRAMEWORKS:
    â€¢ linkedin/STF
    (none)

  WORKFLOWS:
    â€¢ SundayPowerHour

  CONSTRAINTS:
    â€¢ BrandVoice
```

**Tests:**
- 4 CLI tests using Click's CliRunner:
  - Empty list (no blueprints exist yet)
  - Category filtering
  - List with mocked YAML files
  - Help command output
- pytest: PASS (101 total tests, 4 new)

**Manual testing:**
- uv run content-engine blueprints list âœ“
- uv run content-engine blueprints list --category frameworks âœ“
- uv run content-engine blueprints --help âœ“

**Commit:** 15e49f2

---

## [2026-01-17] - CE-BP-006 - Create STF.yaml framework blueprint

**Implemented:**
- Created blueprints/frameworks/linkedin/STF.yaml with comprehensive STF framework definition
- 4 sections: Problem, Tried, Worked, Lesson (each with detailed guidelines)
- Validation rules: 4 sections required, 600-1500 chars
- Compatible pillars: what_building, what_learning, problem_solution
- 2 detailed examples with all four sections
- Best practices, anti-patterns, and voice guidelines

**Files changed:**
- blueprints/frameworks/linkedin/STF.yaml (new)
- tests/test_stf_framework.py (new)

**Learnings:**
- Blueprint YAML structure allows encoding deep content framework knowledge
- Examples in YAML help LLMs understand framework execution
- Guidelines broken down by section provide structured generation hints
- Anti-patterns as important as best practices for quality control
- Voice guidelines ensure brand consistency across generated content

**Codebase patterns discovered:**
- Blueprint examples should follow exact framework structure
- Each section needs both description and actionable guidelines
- Compatible_pillars connects frameworks to content pillars
- Validation rules at framework level set content quality boundaries

**Tests:**
- 10 comprehensive tests for STF blueprint:
  - YAML loading and caching
  - Required fields validation
  - Section structure (4 sections, correct order)
  - Section details (guidelines, descriptions)
  - Validation rules (min/max chars, sections)
  - Compatible pillars
  - Examples structure
  - Best practices/anti-patterns
  - Voice guidelines
- pytest: PASS (111 total tests, 10 new)
- ruff: PASS (new files clean)
- mypy: Pre-existing errors only

**Manual testing:**
- uv run content-engine blueprints list âœ“ (shows linkedin/STF)
- Blueprint loads successfully via blueprint_loader âœ“

**Commit:** 7501e1b

---

## [2026-01-17] - CE-BP-007 - Create MRS.yaml framework blueprint

**Implemented:**
- Created blueprints/frameworks/linkedin/MRS.yaml with comprehensive MRS framework
- 3 sections: Mistake, Realization, Shift (vulnerability-driven narrative)
- Validation rules: 3 sections required, 500-1300 chars
- Compatible pillars: what_learning, problem_solution, sales_tech
- 2 detailed examples showing vulnerability and growth
- Best practices, anti-patterns, and voice guidelines

**Files changed:**
- blueprints/frameworks/linkedin/MRS.yaml (new)
- tests/test_mrs_framework.py (new)

**Learnings:**
- MRS framework emphasizes personal vulnerability and authenticity
- Causal chain (Mistake â†’ Realization â†’ Shift) is critical structure
- Examples should show both the struggle and the transformation
- Anti-patterns help prevent humble-bragging disguised as vulnerability
- Voice guidelines emphasize honesty without self-deprecation

**Codebase patterns discovered:**
- Framework differences: MRS focuses on personal growth vs STF on problem-solving
- Shorter min/max chars for MRS (500-1300) vs STF (600-1500)
- Compatible pillars vary by framework nature (MRS excludes what_building)
- Test pattern established: 10-11 tests per framework blueprint

**Tests:**
- 11 comprehensive tests for MRS blueprint:
  - YAML loading and caching
  - Required fields validation
  - Section structure (3 sections: Mistake/Realization/Shift)
  - Section details validation
  - Validation rules
  - Compatible pillars
  - Examples structure
  - Best practices/anti-patterns
  - Voice guidelines
  - Description content check
- pytest: PASS (122 total tests, 11 new)
- ruff: PASS (Python test file clean)
- mypy: Pre-existing errors only

**Manual testing:**
- uv run content-engine blueprints list --category frameworks âœ“
- Shows both linkedin/MRS and linkedin/STF âœ“

**Commit:** e8e894d

---

## [2026-01-17] - CE-BP-008 - Create SLA.yaml framework blueprint

**Implemented:**
- Created blueprints/frameworks/linkedin/SLA.yaml with comprehensive SLA framework
- 3 sections: Story, Lesson, Application (narrative teaching format)
- Validation rules: 3 sections required, 500-1400 chars
- Compatible pillars: what_learning, what_building, sales_tech
- 2 detailed examples with concrete stories and actionable applications
- Best practices, anti-patterns, and voice guidelines

**Files changed:**
- blueprints/frameworks/linkedin/SLA.yaml (new)
- tests/test_sla_framework.py (new)

**Learnings:**
- SLA framework balances storytelling with actionable takeaways
- Story section needs specific details and stakes to be engaging
- Lesson must feel earned from the story (not tacked on)
- Application section requires numbered, concrete steps
- Voice shifts between sections: narrative (story) â†’ clear (lesson) â†’ practical (application)

**Codebase patterns discovered:**
- All three frameworks now follow consistent YAML structure
- Test pattern standardized: 11 tests per framework
- Compatible pillars vary: SLA includes what_building (unlike MRS)
- Character limits reflect framework density (SLA 500-1400, STF 600-1500)

**Tests:**
- 11 comprehensive tests for SLA blueprint:
  - YAML loading and caching
  - Required fields validation
  - Section structure (3 sections: Story/Lesson/Application)
  - Section details validation
  - Validation rules
  - Compatible pillars
  - Examples structure
  - Best practices/anti-patterns
  - Voice guidelines
  - Description content check
- pytest: PASS (133 total tests, 11 new)
- ruff: PASS
- mypy: Pre-existing errors only

**Manual testing:**
- uv run content-engine blueprints list --category frameworks âœ“
- Shows all three frameworks: MRS, SLA, STF âœ“

**Commit:** 50682c7

---

## [2026-01-17] - CE-BP-009 - Create PIF.yaml framework blueprint

**Implemented:**
- Created blueprints/frameworks/linkedin/PIF.yaml with comprehensive Poll/Interactive framework
- 4 sections: Hook, Interactive_Element, Context, Call_to_Action
- Validation rules: 4 sections required, 300-1000 chars (shorter for engagement posts)
- Compatible pillars: ALL four pillars (most versatile framework)
- 3 detailed examples: poll format, open question, discussion prompt
- Best practices, anti-patterns, voice guidelines
- Added unique engagement_tactics section (PIF-specific)

**Files changed:**
- blueprints/frameworks/linkedin/PIF.yaml (new)
- tests/test_pif_framework.py (new)

**Learnings:**
- PIF framework designed for maximum engagement/participation
- Shorter char limits (300-1000) vs narrative frameworks (500-1500)
- Engagement tactics are framework-specific (follow-through builds trust)
- Interactive element must be specific and low-friction
- Creating psychological safety encourages honest responses
- PIF compatible with all pillars (engagement works across topics)

**Codebase patterns discovered:**
- Framework-specific fields (engagement_tactics) extend base structure
- Compatible_pillars can include all four (PIF) or subset (MRS)
- Character limits correlate with framework purpose (engagement vs narrative)
- All four frameworks now complete: STF, MRS, SLA, PIF
- Test count pattern: 10-12 tests per framework based on complexity

**Tests:**
- 12 comprehensive tests for PIF blueprint:
  - YAML loading and caching
  - Required fields (including engagement_tactics)
  - Section structure (4 sections: Hook/Interactive/Context/CTA)
  - Section details validation
  - Validation rules
  - Compatible pillars (all 4)
  - Examples structure (3 examples)
  - Best practices/anti-patterns
  - Voice guidelines
  - Engagement tactics
  - Description content check
- pytest: PASS (145 total tests, 12 new)
- ruff: PASS
- mypy: Pre-existing errors only

**Manual testing:**
- uv run content-engine blueprints list --category frameworks âœ“
- Shows all four frameworks: MRS, PIF, SLA, STF âœ“

**Commit:** ed1f3b4

---

## [2026-01-17] - CE-BP-010 - Create BrandVoice.yaml constraint

**Implemented:**
- Created blueprints/constraints/BrandVoice.yaml with comprehensive brand voice definition
- 5 core characteristics with examples and guidelines:
  - technical_but_accessible
  - authentic
  - confident
  - builder_mindset
  - specificity_over_generic
- Forbidden phrases across 4 categories (40+ phrases to avoid)
- Style rules: narrative_voice, structure, tone, technical_communication
- Content principles (8 core principles)
- Validation flags: red_flags, yellow_flags, green_signals

**Files changed:**
- blueprints/constraints/BrandVoice.yaml (new)
- tests/test_brandvoice_constraint.py (new)

**Learnings:**
- YAML parsing errors from parenthetical comments outside quotes
- Constraints provide validation criteria for content generation
- Each characteristic includes both good and bad examples
- Forbidden phrases organized by category (easier to reason about)
- Validation flags provide graduated severity levels

**Codebase patterns discovered:**
- Constraint blueprints differ from frameworks (validations vs structures)
- Examples in constraints use good/bad pairs for clarity
- load_constraints() function works same as load_framework()
- Cache key pattern: "constraint:{name}" vs "framework:{platform}:{name}"

**YAML gotchas fixed:**
- Cannot put parenthetical comments after quoted strings in list items
- Bad: `- "phrase" (comment here)` â†’ YAML parse error
- Good: `- "phrase (comment here)"` â†’ parsed correctly
- Simplified forbidden_phrases to just list strings without annotations

**Tests:**
- 10 comprehensive tests for BrandVoice constraint:
  - YAML loading and caching
  - Required fields validation
  - Characteristics structure (5 core IDs)
  - Forbidden phrases (4 categories)
  - Style rules (4 categories)
  - Content principles
  - Validation flags (red/yellow/green)
  - Examples structure (good/bad pairs)
- pytest: PASS (155 total tests, 10 new)
- ruff: PASS
- mypy: Pre-existing errors only

**Manual testing:**
- uv run content-engine blueprints list âœ“
- BrandVoice shows under CONSTRAINTS âœ“

**Commit:** 4497e0e

---

## [2026-01-17] - CE-BP-011 - Create ContentPillars.yaml constraint

**Implemented:**
- Created blueprints/constraints/ContentPillars.yaml with comprehensive pillar definitions
- Four pillars with distribution: what_building (35%), what_learning (30%), sales_tech (20%), problem_solution (15%)
- Each pillar includes: name, description, percentage, examples, characteristics, themes
- Distribution rules: 3-7 posts/week, ideal 5, weekly balance tracking
- Validation rules: balance checks (Â±10% warning, Â±20% error), min posts per pillar
- Content principles for pillar-framework mapping and rotation
- Balanced week example + poor balance example with fixes

**Files changed:**
- blueprints/constraints/ContentPillars.yaml (new)
- tests/test_contentpillars_constraint.py (new)
- scripts/ralph/prd.json (updated CE-BP-011 passes: true)

**Learnings:**
- Content pillars define topical distribution strategy (35%/30%/20%/15% balance)
- Each pillar has unique characteristics and themes for content categorization
- Distribution rules track over 7-day rolling window (not per-post)
- Validation severity levels: warning (Â±10%) vs error (Â±20%)
- Pillar determines framework choice pattern (e.g., what_building â†’ STF/SLA)
- Examples show both ideal balance and common mistakes with fixes

**Codebase patterns discovered:**
- Pillar percentage total validates to 100%
- Each pillar structure: name, description, percentage, examples, characteristics, themes
- Distribution tracking uses rolling window (weekly/monthly)
- Validation gradients: warning â†’ error based on severity
- Content principles connect pillars to frameworks and guide rotation

**Tests:**
- 11 comprehensive tests for ContentPillars constraint:
  - YAML loading and caching
  - Required fields validation
  - Four pillars with correct percentages
  - Pillar structure validation
  - Distribution rules (weekly min/max/ideal)
  - Validation rules (severity levels)
  - Content principles
  - Balanced/poor balance examples
  - Metadata fields
- pytest: PASS (166 total tests, 11 new)
- ruff: PASS (removed unused pytest import)
- mypy: PASS (test file clean)

**Manual testing:**
- uv run content-engine blueprints list --category constraints âœ“
- Shows BrandVoice and ContentPillars âœ“

**Commit:** 2e3cb0c

---

## [2026-01-17] - CE-BP-012 - Implement blueprint_engine.py with validation

**Implemented:**
- Created lib/blueprint_engine.py with core validation engine
- validate_content(content, framework, platform) validates against framework + brand voice
- check_brand_voice(content) detects forbidden phrases from BrandVoice constraint
- select_framework(pillar, context) chooses appropriate framework based on pillar + context
- ValidationResult dataclass with is_valid, violations, warnings, suggestions, score

**Files changed:**
- lib/blueprint_engine.py (new)
- tests/test_blueprint_engine.py (new)
- scripts/ralph/prd.json (updated CE-BP-012 passes: true)

**Learnings:**
- Validation combines framework structure checks + brand voice constraints
- Score calculation: 1.0 - (violations * 0.2) - (warnings * 0.05)
- Framework selection uses default mapping + context-aware overrides
- Default mapping: what_buildingâ†’STF, what_learningâ†’MRS, sales_techâ†’STF, problem_solutionâ†’STF
- Context keywords override defaults: poll/questionâ†’PIF, mistake/failedâ†’MRS
- Forbidden phrases match must be exact (case-insensitive) from YAML
- BrandVoice has 4 categories of forbidden phrases: corporate_jargon, hustle_culture, empty_motivational, vague_business_speak

**Codebase patterns discovered:**
- ValidationResult dataclass provides structured validation output
- Violations are errors (must fix), warnings are suggestions (should fix)
- Score 0.0-1.0 indicates content quality (1.0 = perfect)
- Brand voice checking iterates through forbidden phrase categories
- Framework selection can be overridden by context keywords
- Case-insensitive matching for forbidden phrases using .lower()

**Tests:**
- 22 comprehensive tests for blueprint_engine:
  - validate_content with all 4 frameworks
  - Character length validation (min/max from YAML)
  - Score calculation and suggestions
  - Brand voice forbidden phrase detection (single/multiple)
  - Case-insensitive matching
  - Framework selection for all 4 pillars
  - Context-based framework overrides
  - ValidationResult dataclass structure
- pytest: PASS (188 total tests, 22 new)
- ruff: PASS (removed unused variable)
- mypy: PASS

**Commit:** 31134be

---

## [2026-01-17] - CE-BP-013 - Create LinkedInPost.hbs template

**Implemented:**
- Created blueprints/templates/LinkedInPost.hbs Mustache template
- Structured LLM prompt with 5 sections: CONTEXT, CONTENT PILLAR, FRAMEWORK, BRAND VOICE CONSTRAINTS, VALIDATION REQUIREMENTS, TASK
- Template variables for context (themes/decisions/progress), pillar, framework, brand voice, validation rules
- Clear instructions for LLM: follow framework structure, match brand voice, avoid forbidden phrases, stay within char limits

**Files changed:**
- blueprints/templates/LinkedInPost.hbs (new)
- tests/test_linkedin_template.py (new)
- scripts/ralph/prd.json (updated CE-BP-013 passes: true)

**Learnings:**
- Mustache template syntax: {{#array}}...{{/array}} for iteration, {{variable}} for values
- BrandVoice characteristics is a list of objects (with "id" field), not a dict
- BrandVoice style_rules is a dict where values are lists of strings
- Template must handle both dict and list structures from YAML blueprints
- Rendering complex nested data requires careful context preparation
- Template combines multiple blueprints (framework, pillar, brand voice) into single prompt

**Codebase patterns discovered:**
- Template context preparation transforms YAML structures into renderable format
- Characteristics: list comprehension with char["id"] and char["description"]
- Style rules: dict iteration with ", ".join(rules) for list values
- Forbidden phrases: flattened from dict of categories to simple list
- Framework sections passed directly from YAML structure
- Template variables match what LLM needs to generate quality content

**Tests:**
- 8 comprehensive tests for LinkedInPost template:
  - Renders successfully with full context
  - Includes context sections (themes/decisions/progress)
  - Includes framework sections (all 4 sections for STF)
  - Includes brand voice (characteristics, forbidden phrases, style)
  - Includes validation requirements (char limits, section counts)
  - Works with MRS framework
  - Works with PIF framework
  - Handles empty context gracefully
- pytest: PASS (196 total tests, 8 new)
- ruff: PASS (removed unused variables)
- mypy: PASS

**Commit:** 5e468d4

---

## [2026-01-17] - CE-BP-014 - Implement content_generator.py

**Implemented:**
- Created agents/linkedin/content_generator.py with blueprint-based generation
- generate_post() with auto-framework selection, template rendering, LLM calls, iterative refinement
- _prepare_template_context() transforms YAML blueprints into template-ready format
- GenerationResult dataclass with content, framework_used, validation_score, is_valid, iterations, violations
- Integrates OllamaClient from lib/ollama.py for LLM calls
- Iterative refinement loop (max 3 attempts) with validation feedback

**Files changed:**
- agents/linkedin/content_generator.py (new)
- tests/test_content_generator.py (new)
- scripts/ralph/prd.json (updated CE-BP-014 passes: true)

**Learnings:**
- Pillar characteristics in YAML are list of single-key dicts, not multi-key dict
- Access pattern: list(char.keys())[0] and list(char.values())[0]
- Template context requires flattening nested YAML structures
- Style rules (dict with list values) need ", ".join() for template rendering
- Iterative refinement: first attempt uses base prompt, subsequent use violations as feedback
- Best attempt tracking ensures we return something even if never fully valid
- AIError on first attempt re-raises (fail fast), on refinement breaks loop (graceful degradation)

**Codebase patterns discovered:**
- generate_post() orchestrates full pipeline: load blueprints â†’ prepare context â†’ render template â†’ LLM call â†’ validate â†’ refine
- _prepare_template_context() is pure function transforming YAML â†’ template dict
- GenerationResult bundles all relevant metadata about generation attempt
- Mocked LLM tests use side_effect for multiple return values (test retry logic)
- Template context limits forbidden phrases to 15 for prompt brevity
- Validation feedback loop: violations from attempt N become refinement instructions for attempt N+1

**Tests:**
- 13 comprehensive tests for content_generator:
  - Auto-selects framework (what_building â†’ STF)
  - Uses specified framework
  - Returns valid content (first try success)
  - Retries on invalid (too short â†’ valid)
  - Returns best after max iterations
  - Raises AIError on first failure
  - Handles refinement failure gracefully
  - Works with PIF framework
  - Supports custom models
  - Template context preparation
  - Limits forbidden phrases
  - Handles empty context
  - GenerationResult dataclass
- pytest: PASS (209 total tests, 13 new)
- ruff: PASS (removed unused variable)
- mypy: PASS (type annotations added)

**Commit:** 460ca41

---

## [2026-01-17] - CE-BP-015 - Add generate CLI command

**Implemented:**
- Added generate CLI command to cli.py with blueprint-based content generation
- Command options: --pillar (required), --framework (optional), --date (optional), --model (optional)
- Full workflow: context capture â†’ synthesis â†’ generation â†’ validation â†’ database save
- Displays validation warnings, content preview, and next steps to user

**Files changed:**
- cli.py (added generate command function)
- tests/test_generate_cli.py (new - 14 comprehensive tests)

**Learnings:**
- Click's required=True enforces option presence without default value
- Multiple mocking layers needed: LLM, database, file system, context synthesis
- lambda p: setattr() pattern for mock database refresh to set post.id
- Exception hierarchy matters: FileNotFoundError vs AIError vs generic Exception
- Content preview truncation (500 chars) improves CLI UX for long posts

**Codebase patterns discovered:**
- CLI error handling: specific error types get targeted messages (AIError â†’ "Make sure Ollama is running")
- Database pattern: add â†’ commit â†’ refresh to populate auto-generated fields
- Missing projects directory handled gracefully (warning, not error)
- Next steps display helps user understand workflow progression
- DailyContext conversion to dict needed for generate_post() interface

**Tests:**
- 14 comprehensive tests for generate command:
  - Required/optional argument validation
  - Valid pillar/framework choice enforcement
  - Auto-framework selection vs specified framework
  - Custom date and model options
  - Validation warnings display
  - Error handling (missing sessions, AI errors, invalid dates)
  - Database save verification
  - Next steps display
- All tests use mocked dependencies (no real LLM/DB/filesystem calls)
- pytest: PASS (14 new tests, 210 total)
- ruff: PASS (test file clean)
- mypy: Pre-existing errors only

**Commit:** fa20501

---

